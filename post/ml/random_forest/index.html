
<!DOCTYPE html>
<html lang="en-us">
<head>

  
  <meta charset="UTF-8">
  <title>
    Random Forest | Learn and record
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="http://cherishzhang.github.io/post/ml/random_forest/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">

  
  <link href="http://cherishzhang.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Learn and record" />
  <link href="http://cherishzhang.github.io/index.xml" rel="feed" type="application/rss+xml" title="Learn and record" />

  
  
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="http://cherishzhang.github.io/">Learn and record</a></h1>
        
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="http://cherishzhang.github.io/about" target="_blank">About me</a></li>
          <li><a href="https://github.com/Cherishzhang" target="_blank">GitHub</a></li>
          <li><a href="cherishzhang920508@gmail.com" target="_blank">Email</a></li>
        </ul>
      </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>Random Forest</h1>
      <div class="meta">
        Aug 3, 2016 &nbsp;
        
          #<a href="/tags/machine-learning">machine learning</a>&nbsp;
        
          #<a href="/tags/tree">tree</a>&nbsp;
        
          #<a href="/tags/bagging">bagging</a>&nbsp;
        
      </div>
    </div>
    <article>
      

<h2 id="1-intro:00635f635026fbac82e8a20eddd81309">1. Intro</h2>

<p>基本原理：一个由多个决策树构成的森林，算法分类结果由这些决策树投票得到，决策树在生成的过程当中分别在行方向和列方向上添加<r>随机过程</r>，行方向上构建决策树时采用<r>放回抽样</r>（bootstraping）得到训练数据，列方向上采用<r>无放回随机抽样</r>得到特征子集，并据此得到其最优切分点。<strong>随机森林通过多个决策树投票结果进行分类，算法不容易出现过度拟合问题。</strong></p>

<h2 id="2-construct:00635f635026fbac82e8a20eddd81309">2. Construct</h2>

<p>分为两方面:<strong><r>数据</r></strong>的随机性选取，以及<strong><r>待选特征</r></strong>的随机选取。</p>

<ul>
<li><p><strong>数据</strong></p>

<ol>
<li>从原始数据集中<strong>有放回</strong>的抽样，构造子数据集，子数据集的数据量和原始数据集相同。</li>
<li>利用子数据集构建子决策树</li>
</ol></li>

<li><p>待选特征</p>

<ol>
<li>在子树的每一个分裂过程中并未用到所有的待选特征。</li>
<li>从原始特征无放回随机抽取一定比例的特征，用所抽取的特征集作特征选择。</li>
<li>假设总的特征数量是M，则比例可为\(\sqrt{M}, \frac{1}{2}\sqrt{M}, 2\sqrt{M}\)。</li>
</ol></li>

<li><p>训练过程：<br/>
input: 给定训练集S，测试集T，特征维数F。确定参数集(CART的数量t，每棵树的深度d，每个节点用到的特征数量f，终止条件：节点上最少的样本数，节点上最少的信息增益m)</p></li>
</ul>

<p>对于i = 1,2,&hellip;,t;</p>

<blockquote>
<p>(1) 从S中有放回的抽样，生成一个大小和S相同的训练集S(i)，作为根节点的样本集，从根节点开始训练。<br/>
(2) a. 如果当前节点满足终止条件，则设置当前节点为叶子节点。</p>

<blockquote>
<ul>
<li>分类问题，该叶子节点的预测输出为当前样本集和中数量最多的那一类C(j),概率p为c(j)占当前样本集的比例；</li>
<li>回归问题，预测输出为当前样本集所有样本的平均值。</li>
</ul>
</blockquote>

<p>(2) b. 如果不满足终止条件，则从F维特征中无放回的随机选取f维特征。利用这f维特征，寻找分类效果最好的那一维特征k及阈值th。当前节点上样本第k维特征小于th的样本被划分到左节点，其余的被划分到右节点。</p>

<p>(3) 重复(1)(2)直到所有节点都被训练过或标记为叶子节点。 <br/>
(4) 重复(1)(2)(3)直到所有的决策树被训练过。 <br/></p>
</blockquote>

<ul>
<li>预测过程：</li>
</ul>

<p>对于i = 1,2,&hellip;,t;</p>

<blockquote>
<p>(1) 从当前树的根节点开始，根据节点对应阈值th，判断是进入左节点还是右节点，直到到达某个叶子节点，并输出预测值。<br/>
(2) 重复执行(1)，直到得到所有树的预测值。<strong>分类问题</strong>，则输出所有树中预测概率总和最大的那一类，即对每个c(j)的p进行累计；<strong>回归问题</strong>，则输出为所有树的平均预测值。</p>
</blockquote>

<h2 id="3-evaluation:00635f635026fbac82e8a20eddd81309">3. Evaluation</h2>

<p>rf无需交叉验证来评价分类的准确性，本身自带OOB（out-of-bag）错误估计。</p>

<h2 id="4-spark-mllib:00635f635026fbac82e8a20eddd81309">4. Spark MLlib</h2>

<p>(1)切分点抽样统计</p>

<p>在单机环境下的决策树对连续变量进行切分点选择时，一般是通过对特征点进行排序，然后取相邻两个数之间的点作为切分点，这在单机环境下是可行的，但如果在分布式环境下如此操作的话，会带来大量的网络传输操作，特别是当数据量达到 PB 级时，算法效率将极为低下。为避免该问题，Spark 中的随机森林在构建决策树时，会对各分区采用一定的子特征策略进行抽样，然后生成各个分区的统计数据，并最终得到切分点。</p>

<p>(2)特征装箱（Binning）</p>

<p>决策树的构建过程就是对特征的取值不断进行划分的过程，对于离散的特征，如果有 M 个值，最多\(2^M-1\)个划分，如果值是有序的，那么就最多 M-1 个划分。比如年龄特征，有老，中，少 3 个值，如果无序有\(2^M-1\)个，即 3 种划分：老|中，少；老，中|少；老，少|中；如果是有序的，即按老，中，少的序，那么只有 m-1 个，即 2 种划分，老|中，少；老，中|少。对于连续的特征，其实就是进行范围划分，而划分的点就是 split（切分点），划分出的区间就是 bin。对于连续特征，理论上 split 是无数的，在分布环境下不可能取出所有的值，因此它采用的是（1）中的切点抽样统计方法。</p>

<p>(3)逐层训练（level-wise training）</p>

<p>单机版本的决策数生成过程是通过递归调用（本质上是深度优先）的方式构造树，在构造树的同时，需要移动数据，将同一个子节点的数据移动到一起。此方法在分布式数据结构上无法有效的执行，而且也无法执行，因为数据太大，无法放在一起，所以在分布式环境下采用的策略是逐层构建树节点（本质上是广度优先），这样遍历所有数据的次数等于所有树中的最大层数。每次遍历时，只需要计算每个节点所有切分点统计参数，遍历完后，根据节点的特征划分，决定是否切分，以及如何切分。</p>

<h2 id="5-codes:00635f635026fbac82e8a20eddd81309">5. Codes</h2>

<p>参考sklearn.ensemble.RandomForestRegressor，sklearn.ensemble.RandomForestClassifier</p>

<p>输入参数</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>n_estimators</td>
<td>一个森林中决策树的个数</td>
</tr>

<tr>
<td>criterion</td>
<td>分类准则，如&rsquo;rmse&rsquo;,&lsquo;gini&rsquo;</td>
</tr>

<tr>
<td>max_depth</td>
<td>树的最大深度，tree-specific</td>
</tr>

<tr>
<td>min_samples_split</td>
<td>中间节点分裂前的最少样本数，tree-specific</td>
</tr>

<tr>
<td>min_samples_leaf</td>
<td>新生成叶节点上的最少样本数，tree-specific</td>
</tr>

<tr>
<td>min_weight_fraction_leaf</td>
<td>叶节点上样本数占全部样本的最小比例值，tree-specific</td>
</tr>

<tr>
<td>max_features</td>
<td>每个节点用到的特征数量，tree-specific</td>
</tr>

<tr>
<td>max_leaf_nodes</td>
<td>每棵树中的叶节点能达到的最大值，tree-specific</td>
</tr>

<tr>
<td>bootstrap</td>
<td>是否构建决策树过程中，对样本进行bootstrap</td>
</tr>

<tr>
<td>oob_score</td>
<td>是否使用out-of-bag样本估计泛化误差</td>
</tr>

<tr>
<td>n_jobs</td>
<td>并行运行的进程数，默认等于CPU的核数</td>
</tr>

<tr>
<td>random_state</td>
<td>随机生成器的种子</td>
</tr>

<tr>
<td>verbose</td>
<td>是否输出构建过程中的信息</td>
</tr>

<tr>
<td>warm_start</td>
<td>设置为是，则使用上次拟合后的solution，再附加决策树，否则，拟合一个新的森林</td>
</tr>

<tr>
<td>class_weight</td>
<td>类别权重列表</td>
</tr>
</tbody>
</table>

<p>模型属性</p>

<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>estimators_</td>
<td></td>
</tr>

<tr>
<td>classes_</td>
<td></td>
</tr>

<tr>
<td>n<em>classes</em></td>
<td></td>
</tr>

<tr>
<td>n<em>features</em></td>
<td></td>
</tr>

<tr>
<td>n_outputs</td>
<td></td>
</tr>

<tr>
<td>feature<em>importances</em></td>
<td></td>
</tr>

<tr>
<td>oob_score</td>
<td></td>
</tr>
</tbody>
</table>

<h2 id="参考链接:00635f635026fbac82e8a20eddd81309">参考链接</h2>

<p><a href="http://www.cnblogs.com/hrlnw/p/3850459.html">RandomForest随机森林总结</a></p>


      
      
    </article>
    
 <aside><div id="disqus_thread"></div></aside>

<script type="text/javascript">
     
    var disqus_shortname = 'http-cherishzhang-github-io';

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



  </main>

  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="http://cherishzhang.github.io/post/ml/boosting/" rel="prev">Boosting</a></span>
    
    
      <span class="next"><a href="http://cherishzhang.github.io/post/word2vec/" rel="next">word2vec模型和源码解析</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="/images/avatar.jpg" width="64" height="64"><br>
      
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

